import requests
import time
bucketList = []


def exists(url):
    try:
        # if this raises an ERROR, that means the bucket does not exist
        response = requests.get(url)
        code = response.status_code
        if code == 200 or code == 403:
            bucketList.append(url)
    except requests.ConnectionError:
        # if the bucket does not exist, just pass, print nothing
        pass
    else:
        pass


def bucketfinder(domain):
    import threading
    bucketList.clear()
    # read all buckets
    file = open("./wordlists/common_bucket_prefixes.txt")
    # read all words in the file
    wordlist = file.read()
    # split by new lines
    buckets = wordlist.splitlines()
    mythreads = []
    # t = threading.Thread(target=exists,kwargs={'url':'https://abc.domain'})
    # t.start()
    exists(f'http://{domain}.s3.amazonaws.com')
    for bucket in buckets:
        url = f"http://{domain}-{bucket}.s3.amazonaws.com"
        t = threading.Thread(target=exists, kwargs={'url': url})
        mythreads.append(t)
        t.start()
    for th in mythreads:
        th.join()
    return bucketList
