try:
    import time
    from sys import __stdout__, stdout
    from threading import Thread
    from subprocess import *
    import os
    import sys
    import subprocess
    import threading
    import readline
    from termcolor import colored

except ImportError:
    print("\ncheck for prerequisities ")


def portscanner(target):
    os.system('clear')
    p = './hosts/'
    try:
        os.mkdir(p)

    except FileExistsError as exc:
        print(exc)
    # global fileObject
    cmd = [
        target + target + " dig +short a " + target +
        "| tail -n1 | anew -q subs_ips.txt",
        "awk -F: '{ print $2 " " $1}' subs_ips.txt | sort -k2 -n | anew -q hosts/subs_ips_vhosts.txt ",
        "cat hosts/subs_ips_vhosts.txt | cut -d ' ' -f2| anew -q hosts/ips.txt "
    ]
    cmd1 = ['for sub in $(cat hosts/ips.txt); do shodan host $sub 2>/dev/null >> hosts/portscan_passive.txt && echo -e "\n\n#######################################################################\n\n" >> hosts/portscan_passive.txt; done',
            'nmap --top-ports 1000 -sV -n --max-retries 2 -iL hosts/ips.txt -oN hosts/portscan_active.txt '
            ]
    try:
        for c in cmd:
            print(c)
            proc = subprocess.run(c, shell=True, stderr=STDOUT, stdout=PIPE)
        if(proc.returncode != 0):
            print(colored('Step 1 Failed! Check/Update prerequisitie packages. \nError: ',
                          'blue', attrs=['bold']) + proc.stderr.rstrip())
            # sys.exit(1)
            return False
        else:
            print(colored("[x] Executed", 'blue', attrs=['bold']))
            print(colored("\n--------------------------------------------",
                  'red', attrs=['bold']))
            print(
                colored("[+] Starting Portscanning", 'red', attrs=['bold']))
            print(colored("--------------------------------------------",
                  'red', attrs=['bold']))

        for c1 in cmd1:
            proc1 = subprocess.run(
                c1, shell=True, stderr=STDOUT, stdout=sys.stdout)
        if(proc1.returncode != 0):
            print(colored('Step 1 Failed! Check/Update prerequisitie packages. \nError: ',
                          'blue', attrs=['bold']) + proc1.stderr.rstrip())
            return False
            # sys.exit(1)
        else:
            print(colored("[x] Executed", 'blue', attrs=['bold']))
            return True
    except:
        return False
        # print("Something went wrong! Trying again\n")

    # scanResult = []
    # with open('hosts/ips.txt') as ips:
    #     ipResult = ips.readlines()
    # with open('hosts/portscan_active.txt') as active:
    #     portResult = active.readlines()
    # scanResult.append(ipResult)
    # scanResult.append(portResult)
    # try:
    #     subprocess.run('rm hosts/*.txt', shell=True, stdout=PIPE)
    #     subprocess.run('rm subs_ips.txt', shell=True, stdout=PIPE)
    # except:
    #     pass
    # return scanResult
